# 真·三十天
## 完全控制二进制文件

欢迎来到真三第四个视频

这个视频主要会向大家介绍我们要用到的一些二进制文件相关的知识和工具

我们先来讨论一下x86架构pc机的启动

上个视频说过，cpu工作的方式是取指令->执行

指令是从内存中取得的

但是在刚刚上电的时候，内存中并没有数据，那么第一条指令是从哪来的呢

在x86体系下bios的厂商和系统开发者之间有一个约定

实际上上电之后最先运行的程序不是我们自己操作系统代码的第一行指令

而是主板上某个芯片的只读存储器中的一段代码，这段代码一般回去检测各个基本的硬件是否能够正常工作

当检测完成之后，会从我们指定的装载操作系统代码的介质中读取头512字节的数据

并且检测512字节的最后两个字节是不是一个约定好的值

把这512字节的数据放入0x7c00这个地址

并跳转到这里

至此，我们的代码获取了控制权

这512字节就是著名的引导扇区，《源码》《orange》《自己动手》里面都有非常详细的资料，推荐详细阅读一下

---

当然，512字节能够承载的逻辑非常少，所以这512字节要做的最关键的任务就是，把我们存储介质上之后的数据读入到内存的某一个地址

然后跳转过去执行

说到这里我们要精确的了解下面两件事情

1.二进制文件在磁盘上的布局
2.二进制文件被加载到内存之后的布局

这两件事情会影响我们编写程序时候如何指定符号的内存偏移

说得太抽象，举个例子

我们的操作系统二进制文件在磁盘上是这样摆放的

首先是512字节的引导扇区代码，紧跟着的是比如10个扇区大小的操作系统代码

512字节的代码在被移动到0x7c00这个地址，然后它把剩下10个扇区的地址一顿折腾，最后折腾到了0地址处，然后从0地址出开始执行

这时才是进入我们系统的主逻辑

这时你会发现，虽然这10个扇区在磁盘上是从第二个扇区开始摆放，但是代码里的符号都知道自己会被加载到0地址处，所以都以0地址作为相对偏移

而躺在磁盘第一个扇区的512字节，虽然在磁盘上很靠前，但是它知道自己将会被加载到0x7c00处，所以自己所有的符号偏移都加上了0x7c00

所以说找准自己的定位很重要，找准的自己的定位，做的事情才能符合自己的身份

---

说到这里我们会发现操作系统这部分的代码有一个非常明显的特点，就是要求二进制文件的布局要精确

我们正常情况下写好一个c语言程序就会用编译器去编译它，生成了一个可执行文件之后我们就去执行它

